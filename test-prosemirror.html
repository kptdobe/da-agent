<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Y-ProseMirror Test Page</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .status {
      display: flex;
      gap: 20px;
      font-size: 14px;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }
    .status-dot.connected { background: #22c55e; }
    .status-dot.synced { background: #3b82f6; }
    
    .editor-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 500px;
    }
    
    .ProseMirror {
      position: relative;
      white-space: pre-wrap;
      word-wrap: break-word;
      outline: none;
      padding: 20px;
      min-height: 400px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background: white;
    }
    
    .ProseMirror p {
      margin: 1em 0;
    }
    
    .ProseMirror h1 { font-size: 2em; margin: 0.67em 0; font-weight: bold; }
    .ProseMirror h2 { font-size: 1.5em; margin: 0.75em 0; font-weight: bold; }
    .ProseMirror h3 { font-size: 1.17em; margin: 0.83em 0; font-weight: bold; }
    
    .ProseMirror ul, .ProseMirror ol {
      padding-left: 30px;
    }
    
    .ProseMirror table {
      border-collapse: collapse;
    }
    
    .ProseMirror td, .ProseMirror th {
      border: 1px solid #ddd;
      padding: 8px;
    }
    
    /* Y-prosemirror cursor styles */
    .ProseMirror-yjs-cursor {
      position: absolute;
      border-left: 2px solid;
      border-color: inherit;
      height: 1.2em;
      pointer-events: none;
    }
    
    .ProseMirror-yjs-selection {
      background-color: inherit;
      opacity: 0.3;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .controls h3 {
      margin: 0 0 15px 0;
    }
    
    .controls h4 {
      margin: 0 0 10px 0;
      color: #374151;
      font-size: 16px;
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .control-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      font-family: monospace;
    }
    
    .control-group button {
      padding: 10px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .control-group button:hover {
      background: #2563eb;
    }
    
    .control-group button[style*="background: #8b5cf6"]:hover {
      background: #7c3aed !important;
    }
    
    .control-group button[style*="background: #ef4444"]:hover {
      background: #dc2626 !important;
    }
    
    .log {
      background: #1f2937;
      color: #e5e7eb;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 15px;
    }
    
    .log-entry {
      margin-bottom: 5px;
    }
    
    .log-entry.error { color: #ef4444; }
    .log-entry.success { color: #22c55e; }
    .log-entry.info { color: #3b82f6; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Y-ProseMirror Test Page</h1>
      <div class="status">
        <div class="status-item">
          <div class="status-dot" id="connection-dot"></div>
          <span id="connection-status">Disconnected</span>
        </div>
        <div class="status-item">
          <div class="status-dot" id="sync-dot"></div>
          <span id="sync-status">Not synced</span>
        </div>
        <div class="status-item">
          <span id="users-status">0 users</span>
        </div>
      </div>
    </div>
    
    <div class="editor-container">
      <div id="editor"></div>
    </div>
    
    <div class="controls">
      <h3>Test Operations (Server-Side)</h3>
      
      <!-- Insert Content -->
      <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">
        <h4 style="margin: 0 0 10px 0;">Insert Content</h4>
        
        <div class="control-group">
          <label>Content:</label>
          <input type="text" id="insert-text" placeholder="Text to insert" onkeypress="if(event.key==='Enter') insertContent()">
        </div>
        
        <div class="control-group">
          <label>Type:</label>
          <select id="insert-type" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-family: inherit;">
            <option value="paragraph">Paragraph</option>
            <option value="heading1">Heading 1</option>
            <option value="heading2">Heading 2</option>
            <option value="heading3">Heading 3</option>
            <option value="heading4">Heading 4</option>
            <option value="heading5">Heading 5</option>
            <option value="heading6">Heading 6</option>
          </select>
        </div>
        
        <div class="control-group">
          <button onclick="insertContent()">Insert at Cursor</button>
        </div>
      </div>
      
      <!-- Find & Position Cursor -->
      <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">
        <h4 style="margin: 0 0 10px 0;">Find & Position Cursor</h4>
        
        <div class="control-group">
          <label>Find Text:</label>
          <input type="text" id="find-cursor-text" placeholder="Text to find" onkeypress="if(event.key==='Enter') findAndPositionCursor()">
        </div>
        
        <div class="control-group">
          <button onclick="findAndPositionCursor()" style="background: #8b5cf6;">Find & Select</button>
        </div>
      </div>
      
      <!-- Delete Content -->
      <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">
        <h4 style="margin: 0 0 10px 0;">Delete Content</h4>
        
        <div class="control-group">
          <button onclick="deleteCurrentNode()" style="background: #ef4444;">Delete Current Block</button>
        </div>
      </div>
      
      <!-- Replace Text -->
      <div>
        <h4 style="margin: 0 0 10px 0;">Replace Text</h4>
        
        <div class="control-group">
          <label>Find Text:</label>
          <input type="text" id="find-text" placeholder="Text to find" onkeypress="if(event.key==='Enter') testReplace()">
        </div>
        
        <div class="control-group">
          <label>Replace With:</label>
          <input type="text" id="replace-text" placeholder="Replacement text" onkeypress="if(event.key==='Enter') testReplace()">
        </div>
        
        <div class="control-group">
          <button onclick="testReplace()">Replace Text</button>
        </div>
      </div>
      
      <div class="log" id="log"></div>
    </div>
  </div>
  
  <!-- Load complete editor stack (Y.js + ProseMirror + y-prosemirror) -->
  <script src="/chrome-extension/lib/prosemirror-bundle.js"></script>
  
  <script>
    // Parse query parameters
    const params = new URLSearchParams(window.location.search);
    const org = params.get('org') || 'kptdobe';
    const repo = params.get('repo') || 'daplayground';
    const path = params.get('path') || 'agent/surf';
    const collabUrl = params.get('collab') || 'ws://localhost:4711';
    const adminUrl = params.get('admin') || 'http://localhost:8787';
    const backendUrl = params.get('backend') || 'http://localhost:3101';
    
    const docUrl = `${adminUrl}/source/${org}/${repo}/${path}.html`;
    
    // Logging
    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[${type}] ${message}`);
    }
    
    // Visible editor (copy of da.live editor)
    let editor = null;
    let ydoc = null;
    let provider = null;
    let awareness = null;
    
    // Initialize editor
    async function init() {
      log(`Connecting to: ${docUrl}`, 'info');
      log(`Collab server: ${collabUrl}`, 'info');
      
      // Create Y.js document
      ydoc = new window.Y.Doc();
      provider = new window.WebsocketProvider(collabUrl, docUrl, ydoc);
      awareness = provider.awareness;
      
      // Set awareness
      awareness.setLocalStateField('user', {
        color: '#EF4444',
        name: 'Test Page',
        id: `test-page-${awareness.clientID}`
      });
      
      // Listen for connection status
      provider.on('status', ({ status }) => {
        const dot = document.getElementById('connection-dot');
        const text = document.getElementById('connection-status');
        if (status === 'connected') {
          dot.classList.add('connected');
          text.textContent = 'Connected';
          log('Connected to collab server', 'success');
        } else {
          dot.classList.remove('connected');
          text.textContent = 'Disconnected';
          log('Disconnected from collab server', 'error');
        }
      });
      
      // Listen for sync status
      provider.on('sync', (isSynced) => {
        const dot = document.getElementById('sync-dot');
        const text = document.getElementById('sync-status');
        if (isSynced) {
          dot.classList.add('synced');
          text.textContent = 'Synced';
          log('Document synced', 'success');
        }
      });
      
      // Wait for sync
      await new Promise((resolve) => {
        if (provider.synced) {
          resolve();
        } else {
          provider.on('sync', (isSynced) => {
            if (isSynced) {
              resolve();
            }
          });
        }
      });
      
      // Create ProseMirror editor
      const editorDiv = document.getElementById('editor');
      const yXmlFragment = ydoc.getXmlFragment('prosemirror');
      const schema = window.prosemirror.getSchema();
      
      const state = window.prosemirror.EditorState.create({
        schema,
        plugins: [
          window.yProsemirror.ySyncPlugin(yXmlFragment),
          window.yProsemirror.yCursorPlugin(awareness),
          window.yProsemirror.yUndoPlugin(),
        ]
      });
      
      editor = new window.prosemirror.EditorView(editorDiv, {
        state,
        editable: () => true  // Editable like da.live
      });
      
      log('âœ… Editor initialized', 'success');
      
      // Monitor awareness for user count
      awareness.on('change', () => {
        const states = awareness.getStates();
        const userCount = states.size - 1;
        document.getElementById('users-status').textContent = `${userCount} other user(s)`;
      });
    }
    
    // Call server-side operations
    async function callOperation(endpoint, data) {
      try {
        const response = await fetch(`${backendUrl}/api/operations/${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ docUrl, collabUrl, ...data })
        });
        return await response.json();
      } catch (error) {
        return { success: false, message: error.message };
      }
    }
    
    // Find text and position cursor (server-side)
    async function findAndPositionCursor() {
      const searchText = document.getElementById('find-cursor-text').value;
      
      if (!searchText) {
        log('Please enter text to find', 'error');
        return;
      }
      
      log(`Searching for: "${searchText}"`, 'info');
      
      const result = await callOperation('position-cursor', { text: searchText });
      log(result.message, result.success ? 'success' : 'error');
    }
    
    // Delete current block (server-side)
    async function deleteCurrentNode() {
      log('Deleting current block...', 'info');
      
      const result = await callOperation('delete-block', {});
      log(result.message, result.success ? 'success' : 'error');
    }
    
    // Insert content at cursor (server-side)
    async function insertContent() {
      const text = document.getElementById('insert-text').value;
      const nodeType = document.getElementById('insert-type').value;
      
      if (!text) {
        log('Please enter text to insert', 'error');
        return;
      }
      
      log(`Inserting ${nodeType}: "${text}"`, 'info');
      
      const result = await callOperation('insert-at-cursor', { text, nodeType });
      if (result.success) {
        log(result.message, 'success');
        document.getElementById('insert-text').value = '';
      } else {
        log(result.message, 'error');
      }
    }
    
    // Replace text (server-side)
    async function testReplace() {
      const findText = document.getElementById('find-text').value;
      const replaceText = document.getElementById('replace-text').value;
      
      if (!findText || !replaceText) {
        log('Please enter both find and replace text', 'error');
        return;
      }
      
      log(`Replacing: "${findText}" with "${replaceText}"`, 'info');
      
      const result = await callOperation('replace-text', { find: findText, replace: replaceText });
      log(result.message, result.success ? 'success' : 'error');
    }
    
    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      init().catch(err => {
        log(`Initialization error: ${err.message}`, 'error');
      });
    });
  </script>
</body>
</html>
